from fastapi import FastAPI, HTTPException
from docx import Document
import httpx
import os
from datetime import datetime

app = FastAPI()

# === Bitrix24 –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ===
WEBHOOK = "https://izyskaniya.bitrix24.ru/rest/13614/rj3pqolk1fiu6hfr/"
DISK_FOLDER_ID = "1706930"
KP_LINK_FIELD = "UF_CRM_1761672766812"  # –ü–æ–ª–µ –¥–ª—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –ö–ü

def safe_str(value, default="0"):
    """–ó–∞–º–µ–Ω—è–µ—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
    return value if value != "" else default

def format_cost(cost_str):
    try:
        return f"{int(float(cost_str)):,}".replace(",", " ")
    except (ValueError, TypeError):
        return "0"

def build_igi_section(data):
    lines = [
        "–ö–æ–º–ø–ª–µ–∫—Å –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ-–≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–∑—ã—Å–∫–∞–Ω–∏–π:",
        f"1.1. –ü–æ–ª–µ–≤—ã–µ —Ä–∞–±–æ—Ç—ã:",
        f"‚Äî –±—É—Ä–µ–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω –≥–ª—É–±–∏–Ω–æ–π –ø–æ {data['igi_drilling_depth']} –º ‚Äì {data['igi_boreholes']} —Å–∫–≤–∞–∂–∏–Ω;",
        f"‚Äî —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–æ–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–Ω—Ç–æ–≤ ‚Äì {data['igi_sounding_points']} —Ç–æ—á–∫–∏;",
        f"‚Äî –≥–∏–¥—Ä–æ–≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∏ –±—É—Ä–µ–Ω–∏–∏ —Å–∫–≤–∞–∂–∏–Ω;",
        f"‚Äî –æ—Ç–±–æ—Ä –ø—Ä–æ–± –≥—Ä—É–Ω—Ç–æ–≤ –¥–ª—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö –∏—Å–ø—ã—Ç–∞–Ω–∏–π;",
        f"‚Äî –ø–ª–∞–Ω–æ–≤–æ-–≤—ã—Å–æ—Ç–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ —Å–∫–≤–∞–∂–∏–Ω.",
        f"1.2. –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:",
        f"‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –≥—Ä—É–Ω—Ç–æ–≤;",
        f"‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –≥—Ä—É–Ω—Ç–æ–≤;",
        f"‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ—Ä—Ä–æ–∑–∏–π–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≥—Ä—É–Ω—Ç–æ–≤;",
        f"‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ö–∏–º–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –≤–æ–¥.",
        f"1.3. –ö–∞–º–µ—Ä–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã:",
        f"‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –≥—Ä—É–Ω—Ç–æ–≤;",
        f"‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–≤—ã—Ö –∏—Å–ø—ã—Ç–∞–Ω–∏–π –≥—Ä—É–Ω—Ç–æ–≤;",
        f"‚Äî —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –ø–æ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ-–≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º –∏–∑—ã—Å–∫–∞–Ω–∏—è–º.",
        f"–°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç: {data['igi_duration_days']} —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.",
        f"–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç –ø–æ –ø.1 —Å–æ—Å—Ç–∞–≤–∏—Ç: {data['igi_cost']} —Ä—É–±. —Å —É—á–µ—Ç–æ–º –ù–î–°."
    ]
    return "\n".join(lines)

def build_igdi_section(data):
    lines = [
        "–ö–æ–º–ø–ª–µ–∫—Å –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ-–≥–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–∏—Ö –∏–∑—ã—Å–∫–∞–Ω–∏–π:",
        f"2.1. –¢–æ–ø–æ–≥—Ä–∞—Ñ–æ-–≥–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–∞—è —Å—ä–µ–º–∫–∞ —É—á–∞—Å—Ç–∫–∞, –æ–±—â–µ–π –ø–ª–æ—â–∞–¥—å—é {data['igdi_area_ha']} –ì–∞;",
        f"2.2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≥—Ä–∞–Ω–∏—Ü —Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π —Å—ä–µ–º–∫–∏ –ø–æ–ª–µ–≤–æ–≥–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ —Å—ä–µ–º–∫–∏ –≤—Å–µ—Ö –Ω–∞–∑–µ–º–Ω—ã—Ö, –Ω–∞–¥–∑–µ–º–Ω—ã—Ö –∏ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏—Ö —Ç–∏–ø–∞, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –≥–ª—É–±–∏–Ω—ã –∑–∞–ª–æ–∂–µ–Ω–∏—è;",
        f"2.3. –ö–∞–º–µ—Ä–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å—ä–µ–º–∫–∏ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∞ –≤ –º–∞—Å—à—Ç–∞–±–µ {data['igdi_scale']}, —Å–µ—á–µ–Ω–∏–µ —Ä–µ–ª—å–µ—Ñ–∞ —á–µ—Ä–µ–∑ {data['igdi_contour_interval']} –º;",
        f"2.4. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ—Ç—ã –∏ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –Ω–∞–Ω–µ—Å–µ–Ω–∏—è –Ω–∞ —Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –ø–ª–∞–Ω—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∏—Ä—É—é—â–∏—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è—Ö.",
        f"2.5. –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ-–≥–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–∏—Ö –∏–∑—ã—Å–∫–∞–Ω–∏–π.",
        f"–°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç: {data['igdi_duration_days']} —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π (–≤ —Ç–æ–º —á–∏—Å–ª–µ:",
        f"‚Äî —Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—ä—ë–º–∫–∞ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∞ ‚Äì {data['igdi_survey_days']} —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π;",
        f"‚Äî —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∞ —Å –±–∞–ª–∞–Ω—Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—è–º–∏ –∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞ ‚Äì {data['igdi_coordination_days']} —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π).",
        f"–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç –ø–æ –ø. 2: {data['igdi_cost']} —Ä—É–±. —Å —É—á–µ—Ç–æ–º –ù–î–° (–≤ —Ç–æ–º —á–∏—Å–ª–µ:",
        f"‚Äî —Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—ä—ë–º–∫–∞ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∞ ‚Äì {data['igdi_survey_cost']} —Ä—É–±.;",
        f"‚Äî —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∞ —Å –±–∞–ª–∞–Ω—Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—è–º–∏ ‚Äì {data['igdi_coordination_cost']} —Ä—É–±.;",
        f"‚Äî —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞ ‚Äì {data['igdi_report_cost']} —Ä—É–±.).",
        "* –æ–ø–ª–∞—Ç–∞ —Å—á–µ—Ç–æ–≤ –±–∞–ª–∞–Ω—Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª–µ–π –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞ –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—ã —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è. –°—á–µ—Ç–∞ –æ—Ç –±–∞–ª–∞–Ω—Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª–µ–π –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –ó–∞–∫–∞–∑—á–∏–∫.",
        "* –í —Å–æ—Å—Ç–∞–≤–µ —Ä–∞–±–æ—Ç –ø–æ–¥–∞—á–∞ –≤ –ò–°–û–ì–î"
    ]
    return "\n".join(lines)

def build_iei_section(data):
    lines = [
        "–ö–æ–º–ø–ª–µ–∫—Å –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ-—ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–∑—ã—Å–∫–∞–Ω–∏–π:",
        f"3.1. –ü–æ–ª–µ–≤—ã–µ —Ä–∞–±–æ—Ç—ã:",
        f"- –º–∞—Ä—à—Ä—É—Ç–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è {data['iei_area_ha']} –≥–∞;",
        f"- –ø–µ—à–µ—Ö–æ–¥–Ω–∞—è –≥–∞–º–º–∞-—Å—ä–µ–º–∫–∞ —É—á–∞—Å—Ç–∫–∞ {data['iei_area_ha']} –≥–∞;",
        f"- –∑–∞–º–µ—Ä—ã –ú–≠–î –≥–∞–º–º–∞-–∏–∑–ª—É—á–µ–Ω–∏—è - —Å—É–º–º–∞—Ä–Ω–æ {data['iei_gamma_points']} —Ç–æ—á–µ–∫ –≤ –≥—Ä–∞–Ω–∏—Ü–∞—Ö —É—á–∞—Å—Ç–∫–∞ –∏–∑—ã—Å–∫–∞–Ω–∏–π;",
        f"- –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤–ª–∏—è–Ω–∏—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤ (—à—É–º - {data['iei_noise_points']} —Ç–æ—á–∫–∏, –≠–ú–ò - {data['iei_emi_points']} —Ç–æ—á–∫–∏);",
        f"- –æ—Ç–±–æ—Ä {data['iei_soil_samples']} –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–± –ø–æ—á–≤ —Å –≥–ª—É–±–∏–Ω—ã 0,0-0,2 –º –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å–∞–Ω–∏—Ç–∞—Ä–Ω–æ-—Ö–∏–º–∏—á–µ—Å–∫–æ–≥–æ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è —Ç—è–∂–µ–ª—ã—Ö –º–µ—Ç–∞–ª–ª–æ–≤, –±–µ–Ω–∑(–∞)–ø–∏—Ä–µ–Ω–∞ –∏ –Ω–µ—Ñ—Ç–µ–ø—Ä–æ–¥—É–∫—Ç–æ–≤) –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è;",
        f"- –æ—Ç–±–æ—Ä {data['iei_bio_samples']} –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–± –ø–æ—á–≤ —Å –≥–ª—É–±–∏–Ω—ã 0,0-0,2 –º –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –±–∞–∫—Ç–µ—Ä–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ë–ì–ö–ü, —ç–Ω—Ç–µ—Ä–æ–∫–æ–∫–∫–æ–≤, –ø–∞—Ç–æ–≥–µ–Ω–Ω—ã—Ö –±–∞–∫—Ç–µ—Ä–∏–π, –≤ —Ç.—á. —Å–∞–ª—å–º–æ–Ω–µ–ª–ª) –∏ –ø–∞—Ä–∞–∑–∏—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∏—Ü –∏ –ª–∏—á–∏–Ω–æ–∫ –≥–µ–ª—å–º–∏–Ω—Ç–æ–≤, —Ü–∏—Å—Ç –ø–∞—Ç–æ–≥–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Å—Ç–µ–π—à–∏—Ö) –∏ —ç–Ω—Ç–æ–º–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ (–∫—É–∫–æ–ª–∫–∏ –∏ –ª–∏—á–∏–Ω–∫–∏ —Å–∏–Ω–∞–Ω—Ç—Ä–æ–ø–Ω—ã—Ö –º—É—Ö) –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è;",
        f"- –ø–æ—Å–ª–æ–π–Ω—ã–π –æ—Ç–±–æ—Ä {data['iei_layered_samples_deep']} –ø—Ä–æ–± –≥—Ä—É–Ω—Ç–∞ –∏–∑ {data['iei_deep_boreholes']} –≥–µ–æ–ª–æ–≥. —Å–∫–≤–∞–∂–∏–Ω (–ø–æ—Å–ª–æ–π–Ω–æ —Å –≥–ª—É–±–∏–Ω 0,2-1,0 –º, 1,0-2,0 –º, ..., 14,0-15,0 –º) –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å–∞–Ω–∏—Ç–∞—Ä–Ω–æ-—Ö–∏–º–∏—á–µ—Å–∫–æ–≥–æ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è —Ç—è–∂–µ–ª—ã—Ö –º–µ—Ç–∞–ª–ª–æ–≤, –±–µ–Ω–∑(–∞)–ø–∏—Ä–µ–Ω–∞ –∏ –Ω–µ—Ñ—Ç–µ–ø—Ä–æ–¥—É–∫—Ç–æ–≤) –∞–Ω–∞–ª–∏–∑–∞;",
        f"- –ø–æ—Å–ª–æ–π–Ω—ã–π –æ—Ç–±–æ—Ä {data['iei_layered_samples_shallow']} –ø—Ä–æ–±—ã –≥—Ä—É–Ω—Ç–∞ –∏–∑ {data['iei_shallow_boreholes']} –≥–µ–æ–ª–æ–≥. —Å–∫–≤–∞–∂–∏–Ω (–ø–æ—Å–ª–æ–π–Ω–æ —Å –≥–ª—É–±–∏–Ω 0,2-1,0 –º) –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å–∞–Ω–∏—Ç–∞—Ä–Ω–æ-—Ö–∏–º–∏—á–µ—Å–∫–æ–≥–æ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è —Ç—è–∂–µ–ª—ã—Ö –º–µ—Ç–∞–ª–ª–æ–≤, –±–µ–Ω–∑(–∞)–ø–∏—Ä–µ–Ω–∞ –∏ –Ω–µ—Ñ—Ç–µ–ø—Ä–æ–¥—É–∫—Ç–æ–≤) –∞–Ω–∞–ª–∏–∑–∞;",
        f"- –æ—Ç–±–æ—Ä {data['iei_background_soil_samples']} –ø—Ä–æ–± –ø–æ—á–≤ —Å –≥–ª—É–±–∏–Ω—ã 0,0-0,2 –º, 0,2-1,0 –º, ..., 14,0-15,0 –º –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å–∞–Ω–∏—Ç–∞—Ä–Ω–æ-—Ö–∏–º–∏—á–µ—Å–∫–æ–≥–æ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ—Ñ—Ç–µ–ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Ñ–æ–Ω–æ–≤–∞—è –ø—Ä–æ–±–∞) –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è;",
        f"- –ø–æ—Å–ª–æ–π–Ω—ã–π –æ—Ç–±–æ—Ä {data['iei_agro_samples']} –ø—Ä–æ–± –≥—Ä—É–Ω—Ç–∞ –∏–∑ {data['iei_pits']} —à—É—Ä—Ñ–∞ (–ø–æ—Å–ª–æ–π–Ω–æ —Å –≥–ª—É–±–∏–Ω 0,0-0,2; 0,2-0,4; 0,4-0,6; 0,6-0,8; 0,8-1,0 –º) –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∞–≥—Ä–æ—Ö–∏–º–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞;",
        f"- –æ—Ç–±–æ—Ä {data['iei_rad_samples']} –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–± –ø–æ—á–≤ —Å –≥–ª—É–±–∏–Ω—ã 0,0-0,2 –º –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–∞–¥–∏–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è;",
        f"- –æ—Ç–±–æ—Ä {data['iei_water_samples']} –ø—Ä–æ–±—ã –ø–æ–¥–∑–µ–º–Ω–æ–π –≤–æ–¥—ã (–ø—Ä–∏ –≤—Å–∫—Ä—ã—Ç–∏–∏) –∏–∑ {data['iei_water_boreholes']} —Å–∫–≤–∞–∂–∏–Ω—ã;",
        f"- –æ—Ç–±–æ—Ä {data['iei_surface_water_samples']} –ø—Ä–æ–±—ã –≤–æ–¥—ã –∏–∑ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ–≥–æ –≤–æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞;",
        f"- –æ—Ç–±–æ—Ä {data['iei_sediment_samples']} –ø—Ä–æ–±—ã –¥–æ–Ω–Ω—ã—Ö –æ—Ç–ª–æ–∂–µ–Ω–∏–π –∏–∑ –≤–æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞;",
        f"3.2. –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø—Ä–æ–± –ø–æ—á–≤, –≥—Ä—É–Ω—Ç–æ–≤;",
        f"3.3. –ö–∞–º–µ—Ä–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –æ–± –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ-—ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–∑—ã—Å–∫–∞–Ω–∏—è—Ö;",
        f"3.4. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏ –†–æ—Å–≥–∏–¥—Ä–æ–º–µ—Ç–∞ –æ —Ñ–æ–Ω–æ–≤—ã—Ö –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è—Ö –∑–∞–≥—Ä—è–∑–Ω—è—é—â–∏—Ö –≤–µ—â–µ—Å—Ç–≤ –≤ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ–º –≤–æ–∑–¥—É—Ö–µ (–¥–∏–æ–∫—Å–∏–¥ –∞–∑–æ—Ç–∞, –æ–∫—Å–∏–¥ —É–≥–ª–µ—Ä–æ–¥–∞, —Å–µ—Ä—ã –¥–∏–æ–∫—Å–∏–¥ –∏ –≤–∑–≤–µ—à–µ–Ω–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞);",
        f"3.5. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏ –†–æ—Å–≥–∏–¥—Ä–æ–º–µ—Ç–∞ –æ –∫—Ä–∞—Ç–∫–æ–π –∫–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–µ (–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å–µ–∏–≤–∞–Ω–∏—è –ó–í –≤ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ–º –≤–æ–∑–¥—É—Ö–µ);",
        f"3.6. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ–∫ –æ –Ω–∞–ª–∏—á–∏–∏/–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏:",
        "- –æ—Å–æ–±–æ –æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö –ø—Ä–∏—Ä–æ–¥–Ω—ã—Ö —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π;",
        "- –æ–±—ä–µ–∫—Ç–æ–≤ –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –Ω–∞—Å–ª–µ–¥–∏—è;",
        "- —Å–∫–æ—Ç–æ–º–æ–≥–∏–ª—å–Ω–∏–∫–æ–≤ –∏ –∏—Ö —Å–∞–Ω–∏—Ç–∞—Ä–Ω—ã—Ö –∑–æ–Ω;",
        "- –∫—Ä–∞—Å–Ω–æ–∫–Ω–∏–∂–Ω—ã—Ö –≤–∏–¥–æ–≤ –∂–∏–≤–æ—Ç–Ω—ã—Ö –∏ —Ä–∞—Å—Ç–µ–Ω–∏–π;",
        "- –≤–æ–¥–æ–æ—Ö—Ä–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∏–±—Ä–µ–∂–Ω–æ-–∑–∞—â–∏—Ç–Ω—ã—Ö –ø–æ–ª–æ—Å –≤–æ–¥–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤;",
        "- –∑–æ–Ω —Å–∞–Ω–∏—Ç–∞—Ä–Ω–æ–π –æ—Ö—Ä–∞–Ω—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–∏—Ç—å–µ–≤–æ–≥–æ –∏ —Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ-–±—ã—Ç–æ–≤–æ–≥–æ –≤–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏—è;",
        "- –∑–∞—â–∏—Ç–Ω—ã—Ö –ª–µ—Å–æ–≤;",
        "- –∫—É—Ä–æ—Ä—Ç–Ω—ã—Ö –∏ —Ä–µ–∫—Ä–µ–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∑–æ–Ω;",
        "- –æ –ø–æ–ø–∞–¥–∞–Ω–∏–∏ (–Ω–µ –ø–æ–ø–∞–¥–∞–Ω–∏–∏) –æ–±—ä–µ–∫—Ç–∞ –≤ –≥—Ä–∞–Ω–∏—Ü—ã –°–ó–ó –¥—Ä—É–≥–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤;",
        "- –ø–æ–ª–∏–≥–æ–Ω–æ–≤ –¢–ö–û –∏ —Å–≤–∞–ª–æ–∫;",
        "- –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–π –ø–æ–ª–µ–∑–Ω—ã—Ö –∏—Å–∫–æ–ø–∞–µ–º—ã—Ö.",
        f"",
        f"–°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç: {data['iei_duration_days']} —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.",
        f"–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç –ø–æ –ø.3 —Å–æ—Å—Ç–∞–≤–∏—Ç: {data['iei_cost']} —Ä—É–±. —Å —É—á–µ—Ç–æ–º –ù–î–°.",
        f"",
        "*–≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç –Ω–µ –≤–∫–ª—é—á–µ–Ω—ã:",
        "- –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∫–æ-–∫—É–ª—å—Ç—É—Ä–Ω–æ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã —É—á–∞—Å—Ç–∫–∞ (–∞—Ä—Ö–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑—ã—Å–∫–∞–Ω–∏—è);",
        "- –¥–µ–Ω–¥—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã;",
        "- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä—ã–±–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤–æ–¥–æ–µ–º–æ–≤, –ø–æ–∏—Å–∫ –∑–∏–º–æ–≤–∞–ª—å–Ω—ã—Ö —è–º, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å –†–æ—Å—Ä—ã–±–æ–ª–æ–≤—Å—Ç–≤–æ–º;",
        "- –Ω–∞—É—á–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ –º–∏—Ä–∞, –∫—Ä–∞—Å–Ω–æ–∫–Ω–∏–∂–Ω—ã—Ö –≤–∏–¥–æ–≤ —Ä–∞—Å—Ç–µ–Ω–∏–π, –≥—Ä–∏–±–æ–≤ –∏ –∂–∏–≤–æ—Ç–Ω—ã—Ö, –ø–æ–∏—Å–∫ –º–µ—Å—Ç –≥–Ω–µ–∑–¥–æ–≤–∞–Ω–∏—è –ø—Ç–∏—Ü;",
        "- –Ω–∞—É—á–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –≤–æ–¥–Ω—ã—Ö –±–∏–æ—Ä–µ—Å—É—Ä—Å–æ–≤ –≤–æ–¥–æ–µ–º–æ–≤;",
        "- –±–∏–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—á–≤–æ-–≥—Ä—É–Ω—Ç–æ–≤ —Å —Ü–µ–ª—å—é –∏—Ö —ç–∫–æ—Ç–æ–∫—Å–∏–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –æ—Ü–µ–Ω–∫–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ—Ç—Ö–æ–¥–æ–≤ –≥—Ä—É–Ω—Ç–∞."
    ]
    return "\n".join(lines)

def build_igmi_section(data):
    lines = [
        "–ö–æ–º–ø–ª–µ–∫—Å –≥–∏–¥—Ä–æ–º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–∑—ã—Å–∫–∞–Ω–∏–π:",
        f"4.1. –ü–æ–ª–µ–≤—ã–µ —Ä–∞–±–æ—Ç—ã:",
        f"- —Ä–µ–∫–æ–≥–Ω–æ—Å—Ü–∏—Ä–æ–≤–æ—á–Ω–æ–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ, –∫–∞—Ç. —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ II ‚Äì {data['igmi_route_km']} –∫–º;",
        f"- —Ñ–æ—Ç–æ—Ä–∞–±–æ—Ç—ã ‚Äì {data['igmi_photo_count']} —Å–Ω–∏–º–∫–æ–≤.",
        f"4.2. –ö–∞–º–µ—Ä–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã:",
        f"- —Ä–µ–∫–æ–≥–Ω–æ—Å—Ü–∏—Ä–æ–≤–æ—á–Ω–æ–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª–µ–≤—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ ‚Äì {data['igmi_route_km']} –∫–º;",
        f"- —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≥–∏–¥—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∏–∑—É—á–µ–Ω–Ω–æ—Å—Ç–∏ –±–∞—Å—Å–µ–π–Ω–∞ —Ä–µ–∫–∏ –ø—Ä–∏ —á–∏—Å–ª–µ –ø—É–Ω–∫—Ç–æ–≤ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –¥–æ 50 ‚Äì 1 —Ç–∞–±–ª–∏—Ü–∞;",
        f"- —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –≥–∏–¥—Ä–æ–º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∏–∑—É—á–µ–Ω–Ω–æ—Å—Ç–∏ –±–∞—Å—Å–µ–π–Ω–∞ —Ä–µ–∫–∏ –ø—Ä–∏ —á–∏—Å–ª–µ –ø—É–Ω–∫—Ç–æ–≤ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –¥–æ 50 ‚Äì 1 —Å—Ö–µ–º–∞;",
        f"- –ø–æ–¥–±–æ—Ä —Å—Ç–∞–Ω—Ü–∏–π –∏–ª–∏ –ø–æ—Å—Ç–æ–≤ —Å –æ—Ü–µ–Ω–∫–æ–π –∫–∞—á–µ—Å—Ç–≤–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –∏ —Å—Ç–µ–ø–µ–Ω–∏ –∏—Ö —Ä–µ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚Äì 1 —Å—Ç–∞–Ω—Ü–∏—è;",
        f"- –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ä–æ–∑—ã –≤–µ—Ç—Ä–æ–≤ ‚Äì {data['igmi_wind_rose_count']} –≥—Ä–∞—Ñ–∏–∫–∞;",
        f"- –æ—Ü–µ–Ω–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞—Ç–æ–ø–ª–µ–Ω–∏—è/–ø–æ–¥—Ç–æ–ø–ª–µ–Ω–∏—è –≤–æ–¥–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ —É—á–∞—Å—Ç–∫–∞ –∏–∑—ã—Å–∫–∞–Ω–∏–π ‚Äì 1 –æ—Ü–µ–Ω–∫–∞;",
        f"- —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ä–∞–π–æ–Ω–∞ ‚Äì 1 –∑–∞–ø–∏—Å–∫–∞;",
        f"- —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ä–∞–±–æ—Ç ‚Äì 1 –ø—Ä–æ–≥—Ä–∞–º–º–∞;",
        f"- —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞ ‚Äì 1 –æ—Ç—á–µ—Ç.",
        f"",
        f"–°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç: {data['igmi_duration_days']} –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π.",
        f"–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç –ø–æ –ø.4 —Å–æ—Å—Ç–∞–≤–∏—Ç: {data['igmi_cost']} —Ä—É–±. —Å —É—á–µ—Ç–æ–º –ù–î–°.",
        f"*–≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç –Ω–µ –≤–∫–ª—é—á–µ–Ω—ã:",
        f"- –ø–æ–ª–Ω–∞—è –∫–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ - –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã."
    ]
    return "\n".join(lines)

@app.get("/generate-kp")
async def generate_kp(
    deal_id: str,
    object_name: str,
    address: str,
    cadastral_number: str = "",
    date: str = None,
    total_cost: str = "0",
    advance_percent: str = "50",
    validity_days: str = "30",
    igi: str = "0",
    igi_drilling_depth: str = "5",
    igi_boreholes: str = "4",
    igi_sounding_points: str = "4",
    igi_duration_days: str = "35",
    igi_cost: str = "0",
    igdi: str = "0",
    igdi_area_ha: str = "0",
    igdi_scale: str = "1:500",
    igdi_contour_interval: str = "0.5",
    igdi_duration_days: str = "50",
    igdi_survey_days: str = "15",
    igdi_coordination_days: str = "35",
    igdi_cost: str = "0",
    igdi_survey_cost: str = "0",
    igdi_coordination_cost: str = "0",
    igdi_report_cost: str = "0",
    iei: str = "0",
    iei_area_ha: str = "0",
    iei_gamma_points: str = "0",
    iei_noise_points: str = "0",
    iei_emi_points: str = "0",
    iei_soil_samples: str = "0",
    iei_bio_samples: str = "0",
    iei_rad_samples: str = "0",
    iei_surface_water_samples: str = "0",
    iei_sediment_samples: str = "0",
    iei_water_samples: str = "0",
    iei_water_boreholes: str = "0",
    iei_layered_samples_deep: str = "0",
    iei_deep_boreholes: str = "0",
    iei_layered_samples_shallow: str = "0",
    iei_shallow_boreholes: str = "0",
    iei_background_soil_samples: str = "0",
    iei_agro_samples: str = "0",
    iei_pits: str = "0",
    iei_duration_days: str = "35",
    iei_cost: str = "0",
    igmi: str = "0",
    igmi_route_km: str = "0",
    igmi_photo_count: str = "0",
    igmi_wind_rose_count: str = "0",
    igmi_duration_days: str = "40",
    igmi_cost: str = "0"
):
    try:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        data = {
            "object_name": object_name,
            "address": address,
            "cadastral_number": cadastral_number or "‚Äî",
            "date": date or datetime.now().strftime("%d.%m.%Y"),
            "total_cost": format_cost(total_cost),
            "advance_percent": safe_str(advance_percent, "50"),
            "validity_days": safe_str(validity_days, "30"),
            "igi_drilling_depth": safe_str(igi_drilling_depth, "5"),
            "igi_boreholes": safe_str(igi_boreholes, "4"),
            "igi_sounding_points": safe_str(igi_sounding_points, "4"),
            "igi_duration_days": safe_str(igi_duration_days, "35"),
            "igi_cost": format_cost(igi_cost),
            "igdi_area_ha": safe_str(igdi_area_ha, "0"),
            "igdi_scale": igdi_scale or "1:500",
            "igdi_contour_interval": safe_str(igdi_contour_interval, "0.5"),
            "igdi_duration_days": safe_str(igdi_duration_days, "50"),
            "igdi_survey_days": safe_str(igdi_survey_days, "15"),
            "igdi_coordination_days": safe_str(igdi_coordination_days, "35"),
            "igdi_cost": format_cost(igdi_cost),
            "igdi_survey_cost": format_cost(igdi_survey_cost),
            "igdi_coordination_cost": format_cost(igdi_coordination_cost),
            "igdi_report_cost": format_cost(igdi_report_cost),
            "iei_area_ha": safe_str(iei_area_ha, "0"),
            "iei_gamma_points": safe_str(iei_gamma_points, "0"),
            "iei_noise_points": safe_str(iei_noise_points, "0"),
            "iei_emi_points": safe_str(iei_emi_points, "0"),
            "iei_soil_samples": safe_str(iei_soil_samples, "0"),
            "iei_bio_samples": safe_str(iei_bio_samples, "0"),
            "iei_rad_samples": safe_str(iei_rad_samples, "0"),
            "iei_surface_water_samples": safe_str(iei_surface_water_samples, "0"),
            "iei_sediment_samples": safe_str(iei_sediment_samples, "0"),
            "iei_water_samples": safe_str(iei_water_samples, "0"),
            "iei_water_boreholes": safe_str(iei_water_boreholes, "0"),
            "iei_layered_samples_deep": safe_str(iei_layered_samples_deep, "0"),
            "iei_deep_boreholes": safe_str(iei_deep_boreholes, "0"),
            "iei_layered_samples_shallow": safe_str(iei_layered_samples_shallow, "0"),
            "iei_shallow_boreholes": safe_str(iei_shallow_boreholes, "0"),
            "iei_background_soil_samples": safe_str(iei_background_soil_samples, "0"),
            "iei_agro_samples": safe_str(iei_agro_samples, "0"),
            "iei_pits": safe_str(iei_pits, "0"),
            "iei_duration_days": safe_str(iei_duration_days, "35"),
            "iei_cost": format_cost(iei_cost),
            "igmi_route_km": safe_str(igmi_route_km, "0"),
            "igmi_photo_count": safe_str(igmi_photo_count, "0"),
            "igmi_wind_rose_count": safe_str(igmi_wind_rose_count, "0"),
            "igmi_duration_days": safe_str(igmi_duration_days, "40"),
            "igmi_cost": format_cost(igmi_cost)
        }

        sections = []
        if igi == "1":
            sections.append(("–ò–ì–ò", build_igi_section(data)))
        if igdi == "1":
            sections.append(("–ò–ì–î–ò", build_igdi_section(data)))
        if iei == "1":
            sections.append(("–ò–≠–ò", build_iei_section(data)))
        if igmi == "1":
            sections.append(("–ò–ì–ú–ò", build_igmi_section(data)))

        content_lines = []
        for idx, (name, text) in enumerate(sections, start=1):
            prefix_map = {"–ò–ì–ò": "1.", "–ò–ì–î–ò": "2.", "–ò–≠–ò": "3.", "–ò–ì–ú–ò": "4."}
            old_prefix = prefix_map.get(name, "1.")
            new_text = text.replace(old_prefix, f"{idx}.")

            for old_num in ["1", "2", "3", "4"]:
                new_text = new_text.replace(f"–ø.{old_num}", f"–ø.{idx}")
                new_text = new_text.replace(f"–ø. {old_num}", f"–ø. {idx}")

            lines = new_text.split("\n")
            lines[0] = f"{idx}. {lines[0]}"
            content_lines.extend(lines)
            content_lines.append("")

        content = "\n".join(content_lines).strip()

        template_path = os.path.join(os.path.dirname(__file__), "templates", "kp_template.docx")
        if not os.path.exists(template_path):
            raise HTTPException(status_code=400, detail="–®–∞–±–ª–æ–Ω –ö–ü –Ω–µ –Ω–∞–π–¥–µ–Ω")

        doc = Document(template_path)

        for paragraph in doc.paragraphs:
            text = paragraph.text
            if "{{content}}" in text:
                paragraph.text = text.replace("{{content}}", content)
            else:
                for key, value in data.items():
                    placeholder = f"{{{{{key}}}}}"
                    if placeholder in text:
                        text = text.replace(placeholder, str(value))
                paragraph.text = text

        safe_name = "".join(c for c in object_name if c.isalnum() or c in " _-")
        filename = f"KP_{safe_name}_{datetime.now().strftime('%Y%m%d')}.docx"
        output_path = f"/tmp/{filename}"
        doc.save(output_path)

        # –ó–∞–≥—Ä—É–∑–∫–∞ –≤ Bitrix24
        async with httpx.AsyncClient(timeout=30) as client:
            prep_resp = await client.post(
                f"{WEBHOOK}disk.folder.uploadfile.json",
                data={"id": DISK_FOLDER_ID}
            )
            prep_data = prep_resp.json()
            if "result" not in prep_data or "uploadUrl" not in prep_data["result"]:
                raise HTTPException(status_code=500, detail="–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å uploadUrl –æ—Ç Bitrix24")

            upload_url = prep_data["result"]["uploadUrl"]
            field_name = prep_data["result"].get("field", "file")

            with open(output_path, "rb") as f:
                files = {field_name: (filename, f, "application/vnd.openxmlformats-officedocument.wordprocessingml.document")}
                upload_resp = await client.post(upload_url, files=files)

            upload_result = upload_resp.json()
            if "result" not in upload_result:
                raise HTTPException(status_code=500, detail="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –≤ Bitrix24")

            file_id = str(upload_result["result"]["ID"])

        download_url = f"https://izyskaniya.bitrix24.ru/disk/showFile/{file_id}/?filename={filename}"

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –≤ —Å–¥–µ–ª–∫—É
        async with httpx.AsyncClient(timeout=30) as client:
            update_resp = await client.post(
                f"{WEBHOOK}crm.deal.update.json",
                json={
                    "id": deal_id,
                    "fields": {
                        KP_LINK_FIELD: download_url
                    }
                }
            )
            update_data = update_resp.json()
            if "result" not in update_data:
                raise HTTPException(status_code=500, detail="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É –≤ —Å–¥–µ–ª–∫—É")

        os.remove(output_path)

        return {
            "status": "success",
            "message": f"üìÑ –ö–ü –≥–æ—Ç–æ–≤! –°–∫–∞—á–∞—Ç—å –º–æ–∂–Ω–æ –ø–æ —Å—Å—ã–ª–∫–µ: {download_url}",
            "download_url": download_url
        }

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))